<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Energía</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #grafico-container {
            width: 100%;
            max-width: 800px;
            height: 400px;
            margin: auto;
        }
        .stats-container {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">

    <div class="container mt-4">
        <h2 class="text-center">Monitor de Energía</h2>

        <!-- Menú de pestañas -->
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#monitoreo">Monitoreo en Tiempo Real</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#historico">Histórico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#graficos">Gráficos</a>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content mt-3">
            <!-- Monitoreo en Tiempo Real -->
            <div class="tab-pane fade show active" id="monitoreo">
                <h5>Valores Actuales</h5>
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Parámetro</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody id="data-table">
                        <tr><td>Voltaje Fase 1 (V)</td><td id="voltaje1">Cargando...</td></tr>
                        <tr><td>Voltaje Fase 2 (V)</td><td id="voltaje2">Cargando...</td></tr>
                        <tr><td>Voltaje Fase 3 (V)</td><td id="voltaje3">Cargando...</td></tr>
                        <tr><td>Corriente Fase 1 (A)</td><td id="corriente1">Cargando...</td></tr>
                        <tr><td>Corriente Fase 2 (A)</td><td id="corriente2">Cargando...</td></tr>
                        <tr><td>Corriente Fase 3 (A)</td><td id="corriente3">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Histórico -->
            <div class="tab-pane fade" id="historico">
                <h5>Histórico de Energía</h5>
                <label for="rango">Seleccionar Rango:</label>
                <select id="rango">
                    <option value="diario">Diario</option>
                    <option value="semanal">Semanal</option>
                    <option value="mensual">Mensual</option>
                </select>
                <button onclick="exportarExcel()">Exportar a Excel</button>
            </div>

            <!-- Gráficos -->
            <div class="tab-pane fade" id="graficos">
                <h5>Visualización de Datos</h5>
                <label for="variable">Seleccionar Variable:</label>
                <select id="variable" onchange="actualizarGrafico()">
                    <option value="voltaje_fase_1">Voltaje Fase 1</option>
                    <option value="voltaje_fase_2">Voltaje Fase 2</option>
                    <option value="voltaje_fase_3">Voltaje Fase 3</option>
                    <option value="corriente_fase_1">Corriente Fase 1</option>
                    <option value="corriente_fase_2">Corriente Fase 2</option>
                    <option value="corriente_fase_3">Corriente Fase 3</option>
                </select>

                <div id="grafico-container">
                    <canvas id="grafico"></canvas>
                </div>

                <div class="stats-container">
                    <p>Valor Máximo: <span id="valorMax">-</span></p>
                    <p>Valor Mínimo: <span id="valorMin">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart;

        function actualizarDatos() {
            fetch("/api/modbus/")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("voltaje1").innerText = data["Voltaje Fase 1 (V)"] || "Error";
                    document.getElementById("voltaje2").innerText = data["Voltaje Fase 2 (V)"] || "Error";
                    document.getElementById("voltaje3").innerText = data["Voltaje Fase 3 (V)"] || "Error";
                    document.getElementById("corriente1").innerText = data["Corriente Fase 1 (A)"] || "Error";
                    document.getElementById("corriente2").innerText = data["Corriente Fase 2 (A)"] || "Error";
                    document.getElementById("corriente3").innerText = data["Corriente Fase 3 (A)"] || "Error";
                })
                .catch(error => console.error("Error en fetch:", error));
        }

        function exportarExcel() {
            let rango = document.getElementById("rango").value;
            window.location.href = `/api/exportar_excel/?rango=${rango}`;
        }

        function actualizarGrafico() {
            let variable = document.getElementById("variable").value;
            let rango = document.getElementById("rango").value;

            fetch(`/api/historico/?rango=${rango}`)
                .then(response => response.json())
                .then(data => {
                    let valores = data.map(item => item[variable]);
                    let labels = data.map(item => item.fecha);

                    let valorMaximo = Math.max(...valores).toFixed(2);
                    let valorMinimo = Math.min(...valores).toFixed(2);

                    document.getElementById("valorMax").innerText = `Máximo: ${valorMaximo}`;
                    document.getElementById("valorMin").innerText = `Mínimo: ${valorMinimo}`;

                    if (chart) {
                        chart.destroy();
                    }

                    let ctx = document.getElementById("grafico").getContext("2d");
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: variable,
                                data: valores,
                                borderColor: 'blue',
                                borderWidth: 2,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { ticks: { autoSkip: true, maxTicksLimit: 10 } },
                                y: { beginAtZero: false }
                            }
                        }
                    });
                })
                .catch(error => console.error("Error en fetch:", error));
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelector('a[href="#graficos"]').addEventListener("shown.bs.tab", function () {
                actualizarGrafico();
            });
        });

        setInterval(actualizarDatos, 3000);
        actualizarDatos();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
